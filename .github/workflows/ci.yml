name: CI

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: mydb
          MYSQL_USER: user
          MYSQL_PASSWORD: pass
        options: >-
          --health-cmd "mysqladmin ping -h localhost -u user -ppass --silent"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 10

      mongo:
        image: mongo:6
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 10

    env:
      MYSQL_HOST: mysql
      MYSQL_DB_NAME: mydb
      DB_USERNAME: user
      DB_PASSWORD: pass
      MONGODB_HOST: mongo

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - run: python -m pip install --upgrade pip
      - run: 
          pip install -r requirements.txt 
          pip install pytest

      - name: Run tests
        run: 
          cd src
          pytest -v